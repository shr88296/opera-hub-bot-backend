<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Opera Hub Bot Backend</title>
</head>
<body>
    <script>
        const NEWSAPI_KEYS = [
            '1d3d97c541964b1694ecc20e4f041750',
            // Add more keys here for rotation
        ];
        
        function getRandomApiKey() {
            return NEWSAPI_KEYS[Math.floor(Math.random() * NEWSAPI_KEYS.length)];
        }
        
        async function fetchNews() {
            const params = new URLSearchParams(window.location.search);
            const country = params.get('country') || 'us';
            const topic = params.get('topic') || 'general';
            const format = params.get('format');
            
            try {
                const apiKey = getRandomApiKey();
                const newsUrl = `https://newsapi.org/v2/top-headlines?country=${country}&category=${topic.toLowerCase()}&apiKey=${apiKey}&pageSize=10&sortBy=publishedAt`;
                
                const response = await fetch(newsUrl);
                const data = await response.json();
                
                if (data.status === 'error') {
                    throw new Error(data.message);
                }
                
                if (!data.articles || data.articles.length === 0) {
                    throw new Error('No articles found');
                }
                
                // Get the most recent article with content and image
                for (const article of data.articles) {
                    if (article.content && article.urlToImage && article.content !== '[Removed]') {
                        const now = new Date();
                        const articleDate = new Date(article.publishedAt);
                        const hoursDiff = (now - articleDate) / (1000 * 60 * 60);
                        
                        // Only return articles from last 24 hours
                        if (hoursDiff <= 24) {
                            const result = {
                                title: article.title,
                                link: article.url,
                                pubDate: article.publishedAt,
                                author: article.source.name,
                                full_content: article.content || article.description,
                                image: article.urlToImage,
                                country: country,
                                topic: topic
                            };
                            
                            if (format === 'json') {
                                document.body.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
                                return;
                            } else {
                                window.newsData = result;
                                document.body.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
                                return;
                            }
                        }
                    }
                }
                
                throw new Error('No recent articles with sufficient content found');
                
            } catch (error) {
                const fallbackArticle = {
                    title: "Latest Technology News Update",
                    link: "https://newsapi.org",
                    pubDate: new Date().toISOString(),
                    author: "News Service",
                    full_content: "Stay updated with the latest developments in technology and innovation. This content serves as a placeholder while we fetch the most recent news updates.",
                    image: "https://picsum.photos/seed/tech/640/360.jpg",
                    debug_error: error.message
                };
                
                if (format === 'json') {
                    document.body.innerHTML = `<pre>${JSON.stringify(fallbackArticle, null, 2)}</pre>`;
                } else {
                    window.newsData = fallbackArticle;
                    document.body.innerHTML = `<pre>${JSON.stringify(fallbackArticle, null, 2)}</pre>`;
                }
            }
        }
        
        // Auto-fetch when page loads
        if (window.location.search) {
            fetchNews();
        } else {
            document.body.innerHTML = '<h1>Opera Hub Bot Backend</h1><p>Add query parameters: ?country=us&topic=technology&format=json</p>';
        }
    </script>
</body>
</html>
